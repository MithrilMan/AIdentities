@page "/chat"

@inherits AppPage<Chat>

<HeadContent>
   <link href="_content/AIdentities.Chat/AIdentities.Chat.bundle.scp.css" rel="stylesheet">
</HeadContent>

<MudGrid Class="flex-grow-1" Spacing="1" Justify="Justify.SpaceBetween">
   <MudItem xs="9" Class="mud-height-full d-flex flex-column gap-1">
      <MudStack Row="true" AlignItems="AlignItems.Center" Class="mud-elevation-3 px-1">
         <MudText Class="flex-1 text-ellipsis" Typo="Typo.h6">@GetConversationTitle()</MudText>
         <MudTextField T="string" Placeholder="Search Message..." @bind-Value="_state.MessageSearchText" @bind-Value:after="@ApplyFilter"
                       Variant="Variant.Filled" DebounceInterval="250" Class="flex-1 ma-0" Margin="Margin.Dense"
                       Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search"
                       AdornmentColor="Color.Secondary" />
      </MudStack>

      <div class="d-flex flex-column flex-grow-1 overflow-y-auto" id="@LIST_ID">
         <MudPaper Class="d-flex flex-column flex-grow-1 pa-2 gap-1" Outlined="true">
            <MudList Class="list d-flex flex-column flex-grow-1" DisablePadding="true" DisableGutters="true" Dense="true"
                     Clickable="true" SelectedItemChanged="OnSelectedMessageChanged">
               <MudSpacer />
               @foreach (var message in _state.Messages.Items)
               {
                  <MudListItem Class="flex-shrink-0" @key="message" Value="message">
                     <Message ChatMessage="message" IsSelected="@(_state.SelectedMessage == message)" OnDelete="OnDeleteMessage" />
                  </MudListItem>
               }
               @if (_state.IsWaitingReply)
               {
                  <MudListItem Class="flex-shrink-0">
                     <MudSkeleton Animation="Animation.Pulse">
                        <MudStack Row="true" Justify="Justify.FlexStart" AlignItems="AlignItems.End">
                           <MudAvatar Color="Color.Tertiary" Size="Size.Medium">
                              <MudSkeleton SkeletonType="SkeletonType.Circle"></MudSkeleton>
                           </MudAvatar>
                           <MudPaper Class="pa-1" Elevation="2">
                              <MudText Typo="Typo.body2" Align="Align.Start" Class="message">Generating message....</MudText>
                           </MudPaper>
                           <MudSpacer />
                           <MudItem xs="3" />
                        </MudStack>
                     </MudSkeleton>
                  </MudListItem>
               }
            </MudList>
         </MudPaper>
      </div>

      <MudPaper Class="flex-shrink-0 d-flex flex-row pa-0 gap-1 align-center px-1" Elevation="3">
         @if (_state.HasMessageGenerationFailed)
         {
            <MudButton StartIcon="@Icons.Material.Outlined.Refresh" Color="Color.Error" ButtonType="ButtonType.Button" Size="Size.Large" Variant="Variant.Filled"
                    OnClick="Resend" Disabled="@(_state.IsWaitingReply)">Resend</MudButton>
         }
         <MudTextField Variant="Variant.Outlined" Lines="_state.MessageTextLines" @ref="_messageTextField"
                       Placeholder="Enter your message..." Immediate="true" Margin="Margin.Dense" Class="pa-0 ma-0"
                       OnKeyDown="OnKeyDown" Disabled="@(_state.SelectedConversation == null)"
                       @bind-Value="_state.Message" @bind-Value:after="_state.SetMessageTextLines" />
         <MudIconButton Icon="@Icons.Material.Outlined.Send" Color="Color.Secondary" ButtonType="ButtonType.Button" Size="Size.Medium"
                        OnClick="SendMessageAsync" Disabled="@(!_state.CanSendMessage)" />
      </MudPaper>
   </MudItem>

   <MudItem xs="3" Class="mud-height-full">
      <MudPaper Class="mud-height-full">
         <ConversationList Class="mud-height-full" @bind-Conversation="_state.SelectedConversation" @bind-Conversation:after="OnConversationChanged" />
      </MudPaper>
   </MudItem>
</MudGrid>

@code {
   string GetConversationTitle()
   {
      if (_state.SelectedConversation == null)
      {
         return "Select a conversation";
      }
      return _state.SelectedConversation.Title;
   }

   void OnSelectedMessageChanged(MudListItem item) => _state.SelectedMessage = item.Value as ChatMessage;
}
